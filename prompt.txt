PROMPT FOR CREATING NGCSIM - NGSPICE CORNER SIMULATION TOOL
============================================================

Create a Python tool called "ngcsim" for automating corner simulations in ngspice.

OVERVIEW
--------
The tool should parse special configuration commands embedded as comments in 
ngspice netlists, generate netlists for all corner combinations, run simulations, 
and aggregate results into a CSV file.

CORE REQUIREMENTS
-----------------

1. CONFIGURATION VIA NETLIST COMMENTS
   - All configuration is embedded in the netlist as comments (lines starting 
     with * or **)
   - Commands must start with "ngc_" prefix
   - Four command types:

   a) ngc_param - Parameter variations
      Syntax: ngc_param <param_name> <value1> <value2> ... <valueN>
      Example: ** ngc_param vdd_p 2.7 3.0 3.3
      - Parameter names must match .param statements in the netlist
      - Tool replaces parameter values in .param statements for each corner

   b) ngc_lib - Library corner variations
      Syntax: ngc_lib <library_file>[(<key>)] <corner1> <corner2> ... <cornerN>
      Examples: 
        ** ngc_lib process.lib tt ff ss
        ** ngc_lib models.lib(mos_typ) tt ff ss
        ** ngc_lib models.lib(res_typ) res_nom res_fast res_slow
      - Finds .lib statements matching library file and optional key
      - Replaces the key with each corner name
      - Whitespace around key should be ignored when matching
      - Supports multiple libraries with different corner sets (e.g., separate 
        MOS and resistor corners)

   c) ngc_temp - Temperature variations
      Syntax: ngc_temp <temp1> <temp2> ... <tempN>
      Example: ** ngc_temp -40 27 125
      - Temperatures in Celsius
      - If existing .temp statement found, replace it
      - If no .temp statement, insert before first analysis command (.tran, .ac, .dc, .op)
      - If no analysis command, insert before .end
      - Default to 25°C if no ngc_temp specified

   d) ngc_out - Output measurements
      Syntax: ngc_out <measure1> <measure2> ... <measureN>
      Example: ** ngc_out delay_rise delay_fall power
      - Names must match .measure statements in netlist
      - Extract these measurements from ngspice output

2. CORNER GENERATION
   - Generate all combinations (Cartesian product) of:
     * All parameter values
     * All library corners
     * All temperatures
   - Assign unique corner IDs: c0001, c0002, c0003, etc.
   - Create separate netlist file for each corner

3. SIMULATION EXECUTION
   - Run ngspice in batch mode (-b flag) for each corner netlist
   - Support parallel execution with configurable number of workers
   - Extract measurement values from ngspice stdout
   - Handle simulation errors/timeouts gracefully

4. OUTPUT FORMAT
   - Save results to CSV file
   - Columns: corner_id, temperature, param_<name>, lib_<libfile>, <measurements>
   - Do NOT include netlist paths in CSV (even with --keep-netlists)
   - Results should be sorted by corner_id

COMMAND LINE INTERFACE
----------------------
Positional argument:
  netlist               Input netlist file path

Optional arguments:
  -k, --keep-netlists   Keep generated corner netlists (saved in /tmp with 
                        random folder name). Default: delete after simulation.
                        Corner netlists named with corner_id (c0001.sp, etc.)
  
  -j N, --parallel N    Run N simulations in parallel using ProcessPoolExecutor
                        Default: 1 (sequential)
  
  -o FILE, --output     Output CSV filename
                        Default: <input_netlist_base>_corners.csv
  
  -n, --no-run          Generate netlists only, skip simulation
                        Useful with -k for inspecting generated netlists
                        Should warn if used without -k

  -h, --help            Show help message

SCRIPT STRUCTURE
----------------
Use object-oriented design with these classes:

1. NgcConfig - Store parsed configuration (params, libs, temps, outputs)

2. NetlistParser - Parse netlist and extract ngc_ commands
   - Read netlist line by line
   - Identify comment lines with ngc_ commands
   - Parse each command type and populate NgcConfig

3. CornerGenerator - Generate corner combinations and netlists
   - Create all corner combinations via itertools.product
   - Generate modified netlist for each corner:
     * Replace .param values
     * Replace .lib corner names
     * Handle .temp statements (replace/insert as described above)
     * Keep ngc_ comment lines in output

4. SimulationRunner - Execute simulations and extract results
   - Run ngspice subprocess with timeout (suggest 300 seconds)
   - Parse stdout for measurement values (pattern: measure_name = value)
   - Return dict with corner info and measurements

5. Main function - Command line interface and workflow orchestration

ERROR HANDLING
--------------
- Check if input netlist exists
- Handle missing ngspice executable gracefully
- Warn if no ngc_ configuration found (will run single 25°C simulation)
- Warn if no ngc_out measurements defined
- Handle simulation timeouts and errors (mark as TIMEOUT/ERROR in results)
- For parallel execution, catch exceptions per simulation

USER EXPERIENCE
---------------
- Show progress through 5 steps:
  [1/5] Parsing netlist
  [2/5] Generating corner combinations
  [3/5] Creating corner netlists
  [4/5] Running simulations (with progress updates)
  [5/5] Writing results
  
- Display summary of parsed configuration (counts of params, libs, temps, outputs)
- Show progress percentage during simulation
- Display temp directory location
- Show final message about where netlists are kept/removed

DOCUMENTATION
-------------
1. In-script documentation:
   - Comprehensive user guide in script header docstring
   - Explain all ngc_ commands with examples
   - Document command line options
   - Include complete netlist example
   - List dependencies (Python 3.6+, ngspice)

2. Separate README.md:
   - Feature overview
   - Quick start guide
   - Detailed command documentation
   - Complete working example (e.g., CMOS inverter)
   - Tips and best practices
   - Troubleshooting section

EDGE CASES TO HANDLE
--------------------
- Netlist with no ngc_ tags: runs single simulation at 25°C
- No ngc_out tags: runs simulations but extracts no measurements
- Multiple .lib statements for same library with different keys
- Library paths with or without explicit paths
- Parallel execution with results arriving out of order
- Temperature statements already present in netlist

PYTHON DEPENDENCIES
-------------------
Standard library only:
- argparse (CLI)
- csv (output)
- itertools (combinations)
- os, pathlib (file operations)
- re (pattern matching)
- subprocess (ngspice execution)
- sys (exit codes)
- tempfile (temp directories)
- concurrent.futures (parallel execution)
- typing (type hints)

Make the script executable with proper shebang: #!/usr/bin/env python3

STYLE GUIDELINES
----------------
- Use type hints for function parameters and returns
- Include docstrings for all classes and methods
- Use descriptive variable names
- Add comments for complex logic
- Format code cleanly with consistent indentation
- Use f-strings for string formatting
- Include box-drawing characters for visual output (╔═╗ ║ ╚═╝)
